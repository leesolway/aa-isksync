{% extends 'isksync/base.html' %}
{% load i18n %}

{% block page_title %}{% trans "Payment History" %}{% endblock %}

{% block page_header %}
    {% trans "Payment History" %}
{% endblock %}

{% block user_nav %}
{% include "isksync/partials/back_button.html" %}
{% endblock %}

{% block content %}

<!-- Cycles History -->
<div class="card mb-3">
  <div class="card-header">
    {% trans "Cycles" %}
  </div>
  <div class="card-body">
    {% if history_cycles %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>{% trans "System" %}</th>
              <th>{% trans "Period" %}</th>
              <th class="text-end">{% trans "Expected" %}</th>
              <th class="text-end">{% trans "Paid" %}</th>
              <th>{% trans "Status" %}</th>
              <th>{% trans "Paid Date" %}</th>
              <th class="text-end">{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for c in history_cycles %}
              <tr>
<td><a href="{% url 'isksync:ownership_detail' c.system_ownership.pk %}">{{ c.system_ownership.system.name }}</a></td>
                <td>{{ c.period_start|date:"M Y" }}</td>
                <td class="text-end">{{ c.expected_fmt }} ISK</td>
                <td class="text-end">{% if c.paid_amount %}{{ c.paid_fmt }} ISK{% else %}-{% endif %}</td>
                <td>{{ c.get_status_display }}</td>
                <td>{% if c.paid_date %}{{ c.paid_date|date:"M j, Y" }}{% else %}-{% endif %}</td>
                <td class="text-end">
                  {% if c.user_marked_paid %}
                    <form method="post" action="{% url 'isksync:toggle_user_marked_paid' c.pk %}" class="d-inline">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Undo Marked Paid" %}</button>
                    </form>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted mb-0">{% trans "No cycles available." %}</p>
    {% endif %}
  </div>
</div>

<!-- Obligations History -->
<div class="card">
  <div class="card-header">
    {% trans "Obligations" %}
  </div>
  <div class="card-body">
    {% if obligations_history %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>{% trans "System" %}</th>
              <th>{% trans "Period" %}</th>
              <th>{% trans "Obligation" %}</th>
              <th>{% trans "Status" %}</th>
              <th class="text-end">{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in obligations_history %}
              {% with cycle=row.cycle obligation=row.obligation %}
              <tr>
                <td>{{ cycle.system_ownership.system.name }}</td>
                <td>{{ cycle.period_start|date:"M Y" }}</td>
                <td class="fw-semibold">{{ obligation.obligation_type.name }}</td>
                <td>
                  {% if obligation.status == 'COMPLETED' %}
                    <span class="badge bg-success">{% trans "Completed" %}</span>
                  {% elif obligation.status == 'FAILED' %}
                    <span class="badge bg-danger">{% trans "Failed" %}</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <form method="post" action="{% url 'isksync:toggle_obligation_fulfilled' obligation.pk %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="pending" />
                    <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Set Pending" %}</button>
                  </form>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted mb-0">{% trans "No obligations to show." %}</p>
    {% endif %}
  </div>
</div>
{% endblock %}
