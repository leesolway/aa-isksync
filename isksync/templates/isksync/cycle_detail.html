{% extends 'isksync/base.html' %}
{% load i18n %}

{% block page_title %}{{ cycle.system_ownership.system.name }} - {{ cycle.period_start|date:"M Y" }}{% endblock %}

{% block page_header %}
  {{ cycle.system_ownership.system.name }} â€” {{ cycle.period_start|date:"M Y" }}
{% endblock %}

{% block user_nav %}
{% include "isksync/partials/back_button.html" %}
{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-12 col-xl-6">
    <div class="card">
      <div class="card-header"><span class="fw-bold">{% trans "Cycle" %}</span></div>
      <div class="card-body">
        <div class="row mb-2">
          <div class="col-5 text-muted small">{% trans "System" %}</div>
          <div class="col-7">{{ cycle.system_ownership.system.name }}</div>
        </div>
        <div class="row mb-2">
          <div class="col-5 text-muted small">{% trans "Period" %}</div>
          <div class="col-7">{{ cycle.period_start|date:"M Y" }}</div>
        </div>
        <div class="row mb-2">
          <div class="col-5 text-muted small">{% trans "Expected" %}</div>
          <div class="col-7">{{ cycle.expected_fmt }} ISK</div>
        </div>
        <div class="row mb-2">
          <div class="col-5 text-muted small">{% trans "Status" %}</div>
          <div class="col-7">
            {% if cycle.status == 'OVERDUE' %}
              <span class="badge bg-danger">{{ cycle.get_status_display }}</span>
            {% elif cycle.status == 'PENDING' %}
              <span class="badge bg-warning text-dark">{{ cycle.get_status_display }}</span>
            {% elif cycle.status == 'PAID' %}
              <span class="badge bg-success">{{ cycle.get_status_display }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ cycle.get_status_display }}</span>
            {% endif %}
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-5 text-muted small">{% trans "Due Date" %}</div>
          <div class="col-7">{{ cycle.due_date|date:"M j, Y" }}</div>
        </div>
        <div class="row mb-2">
          <div class="col-5 text-muted small">{% trans "Lead Character" %}</div>
          <div class="col-7">
            {% if cycle.system_ownership.primary_user %}
              <span class="badge bg-primary">{{ cycle.system_ownership.primary_user.username }}</span>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-5 text-muted small">{% trans "User Marked Paid" %}</div>
          <div class="col-7">
            {% if cycle.user_marked_paid %}
              <span class="badge bg-success">{% trans "Yes" %}</span>
              {% if cycle.user_marked_paid_at %}<span class="text-muted small"> ({{ cycle.user_marked_paid_at|date:"Y-m-d H:i" }})</span>{% endif %}
            {% else %}
              <span class="badge bg-secondary">{% trans "No" %}</span>
            {% endif %}
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          {% if admin_mode %}
            <form method="post" action="{% url 'isksync:mark_cycle_paid' cycle.pk %}">{% csrf_token %}
              <button class="btn btn-sm btn-success" type="submit">{% trans "Mark Paid" %}</button>
            </form>
            <form method="post" action="{% url 'isksync:exempt_cycle' cycle.pk %}">{% csrf_token %}
              <button class="btn btn-sm btn-outline-danger" type="submit">{% trans "Write Off" %}</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'isksync:toggle_user_marked_paid' cycle.pk %}">{% csrf_token %}
              {% if cycle.user_marked_paid %}
                <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Undo Marked Paid" %}</button>
              {% else %}
                <button class="btn btn-sm btn-success" type="submit">{% trans "I've paid for this period" %}</button>
              {% endif %}
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card h-100">
      <div class="card-header"><span class="fw-bold">{% trans "Members" %}</span></div>
      <div class="card-body">
        {% if members %}
          <div class="small text-muted mb-2">{{ members|length }} {% trans "members" %}</div>
          <div class="d-flex flex-wrap gap-2">
            {% for u in members %}
              <span class="badge bg-secondary">{{ u.username }}</span>
            {% endfor %}
          </div>
        {% else %}
          <span class="text-muted">{% trans "No members found." %}</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header"><span class="fw-bold">{% trans "Obligations" %}</span></div>
      <div class="card-body">
        {% include "isksync/partials/obligation_status.html" with cycle=cycle show_actions=True admin_mode=admin_mode %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
